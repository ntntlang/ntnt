<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NTNT Intent Studio - server.intent</title>
    <style>
      :root {
        --bg-primary: #0d1117;
        --bg-secondary: #161b22;
        --bg-tertiary: #21262d;
        --bg-elevated: #1c2128;
        --border: #30363d;
        --border-hover: #484f58;
        --text-primary: #e6edf3;
        --text-secondary: #8b949e;
        --text-muted: #6e7681;
        --green: #3fb950;
        --green-bg: rgba(63, 185, 80, 0.15);
        --red: #f85149;
        --red-bg: rgba(248, 81, 73, 0.15);
        --yellow: #d29922;
        --yellow-bg: rgba(210, 153, 34, 0.15);
        --blue: #58a6ff;
        --blue-bg: rgba(88, 166, 255, 0.15);
        --purple: #a371f7;
        --purple-bg: rgba(163, 113, 247, 0.15);
        --gray: #484f58;
        --gray-bg: rgba(72, 79, 88, 0.15);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        line-height: 1.5;
        font-size: 13px;
      }

      /* Header */
      .header {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
        padding: 0 16px;
        height: 48px;
        display: flex;
        align-items: center;
        gap: 16px;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        white-space: nowrap;
      }

      .logo img {
        height: 24px;
        width: 24px;
        vertical-align: middle;
      }

      .file-name {
        color: var(--text-secondary);
        font-size: 12px;
        padding: 4px 8px;
        background: var(--bg-tertiary);
        border-radius: 4px;
        white-space: nowrap;
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: auto;
        flex-wrap: nowrap;
        flex-shrink: 0;
      }

      @media (max-width: 900px) {
        .file-name {
          display: none;
        }
      }

      @media (max-width: 600px) {
        .auto-refresh span {
          display: none;
        }
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.1s ease;
      }

      .btn-primary {
        background: var(--green);
        color: #0d1117;
      }

      .btn-primary:hover {
        background: #2ea043;
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: var(--bg-tertiary);
        border-color: var(--border);
        color: var(--text-primary);
      }

      .btn-secondary:hover {
        background: var(--bg-elevated);
        border-color: var(--border-hover);
      }

      .auto-refresh {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--text-secondary);
      }

      .toggle {
        width: 32px;
        height: 18px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 9px;
        position: relative;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .toggle.active {
        background: var(--green-bg);
        border-color: var(--green);
      }

      .toggle::after {
        content: "";
        position: absolute;
        width: 12px;
        height: 12px;
        background: var(--text-muted);
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: all 0.2s ease;
      }

      .toggle.active::after {
        left: 16px;
        background: var(--green);
      }

      .status-pill {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: var(--bg-tertiary);
        border-radius: 20px;
        font-size: 12px;
        color: var(--text-secondary);
      }

      .status-pill.passing {
        background: var(--green-bg);
        color: var(--green);
      }

      .status-pill.failing {
        background: var(--red-bg);
        color: var(--red);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Main container */
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
      }

      /* Summary bar */
      .summary-bar {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px 24px;
        margin-bottom: 20px;
        position: relative;
      }

      .summary-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
      }

      .summary-bar .status-pill {
        position: absolute;
        top: 16px;
        right: 20px;
      }

      .summary-title {
        font-size: 14px;
        font-weight: 600;
      }

      .summary-subtitle {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 2px;
      }

      .health-section {
        margin-bottom: 16px;
      }

      .health-bar-container {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .health-bar {
        flex: 1;
        height: 12px;
        background: var(--bg-tertiary);
        border-radius: 6px;
        overflow: hidden;
        display: flex;
      }

      .health-segment {
        height: 100%;
        transition: width 0.3s ease;
      }

      .health-segment.pass { background: var(--green); }
      .health-segment.fail { background: var(--red); }
      .health-segment.warn { background: var(--yellow); }
      .health-segment.skip { background: var(--gray); }

      .health-percent {
        font-size: 18px;
        font-weight: 600;
        min-width: 50px;
        text-align: right;
      }

      .health-percent.good { color: var(--green); }
      .health-percent.warn { color: var(--yellow); }
      .health-percent.bad { color: var(--red); }

      .summary-stats {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
      }

      .stat {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 6px;
        transition: background 0.1s;
      }

      .stat:hover {
        background: var(--bg-tertiary);
      }

      .stat-icon { font-size: 14px; }
      .stat-icon.pass { color: var(--green); }
      .stat-icon.fail { color: var(--red); }
      .stat-icon.warn { color: var(--yellow); }
      .stat-icon.skip { color: var(--gray); }
      .stat-icon.unlinked { color: var(--purple); }

      .stat-value { font-weight: 600; }
      .stat-label { color: var(--text-secondary); }

      /* Filter bar */
      .filter-bar {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filter-chip {
        padding: 6px 12px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.1s ease;
        color: var(--text-secondary);
      }

      .filter-chip:hover {
        background: var(--bg-tertiary);
      }

      .filter-chip.active {
        background: var(--blue-bg);
        border-color: var(--blue);
        color: var(--blue);
      }

      .filter-chip.active.danger {
        background: var(--red-bg);
        border-color: var(--red);
        color: var(--red);
      }

      .filter-chip.active.warning {
        background: var(--yellow-bg);
        border-color: var(--yellow);
        color: var(--yellow);
      }

      .filter-count {
        background: var(--bg-tertiary);
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 10px;
      }

      .filter-chip.active .filter-count {
        background: rgba(255, 255, 255, 0.15);
      }

      /* Search bar */
      .search-bar {
        position: relative;
        margin-bottom: 20px;
      }

      .search-bar input {
        width: 100%;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 10px 14px 10px 38px;
        color: var(--text-primary);
        font-size: 13px;
        outline: none;
      }

      .search-bar input::placeholder {
        color: var(--text-muted);
      }

      .search-bar input:focus {
        border-color: var(--blue);
        background: var(--bg-tertiary);
      }

      .search-bar-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
      }

      /* Feature card */
      .feature-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 8px;
        overflow: hidden;
      }

      .feature-header {
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: background 0.1s;
      }

      .feature-header:hover {
        background: var(--bg-tertiary);
      }

      .feature-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .feature-icon {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }

      .feature-icon.pass { background: var(--green-bg); color: var(--green); }
      .feature-icon.fail { background: var(--red-bg); color: var(--red); }
      .feature-icon.warn { background: var(--yellow-bg); color: var(--yellow); }
      .feature-icon.skip { background: var(--gray-bg); color: var(--text-muted); }
      .feature-icon.unlinked { background: var(--purple-bg); color: var(--purple); }

      .feature-name {
        font-weight: 500;
        font-size: 14px;
      }

      .feature-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .feature-stats {
        display: flex;
        gap: 8px;
        font-size: 12px;
        color: var(--text-muted);
      }

      .expand-icon {
        color: var(--text-muted);
        font-size: 10px;
        transition: transform 0.2s;
      }

      .feature-card.expanded .expand-icon {
        transform: rotate(180deg);
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
        text-transform: uppercase;
      }

      .badge.unit { background: var(--purple-bg); color: var(--purple); }
      .badge.http { background: var(--blue-bg); color: var(--blue); }
      .badge.unlinked { background: var(--gray-bg); color: var(--text-muted); }

      /* Scenarios */
      .scenarios {
        border-top: 1px solid var(--border);
        display: none;
      }

      .feature-card.expanded .scenarios {
        display: block;
      }

      .feature-description {
        padding: 12px 16px;
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border);
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.6;
      }

      .feature-description .feature-id {
        font-family: ui-monospace, monospace;
        font-size: 11px;
        color: var(--purple);
        margin-bottom: 6px;
      }

      .scenario {
        border-bottom: 1px solid var(--border);
      }

      .scenario:last-child {
        border-bottom: none;
      }

      .scenario-header {
        padding: 10px 16px 10px 46px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: background 0.1s;
      }

      .scenario-header:hover {
        background: var(--bg-tertiary);
      }

      .scenario-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .scenario-icon {
        font-size: 12px;
      }

      .scenario-icon.pass { color: var(--green); }
      .scenario-icon.fail { color: var(--red); }
      .scenario-icon.warn { color: var(--yellow); }
      .scenario-icon.skip { color: var(--text-muted); }

      .scenario-name {
        font-size: 13px;
      }

      .scenario-meta {
        font-size: 11px;
        color: var(--text-muted);
      }

      /* Assertions */
      .assertions {
        background: var(--bg-primary);
        display: none;
        padding: 12px 16px 12px 46px;
      }

      .scenario.expanded .assertions {
        display: block;
      }

      .when-clause {
        padding: 10px 14px;
        background: var(--bg-tertiary);
        border-radius: 6px;
        margin-bottom: 12px;
        font-size: 12px;
      }

      .when-line {
        color: var(--text-primary);
      }

      .when-label {
        color: var(--purple);
        font-weight: 500;
      }

      .resolution {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 6px;
        padding-left: 12px;
        border-left: 2px solid var(--border);
      }

      .assertion {
        padding: 6px 0;
        border-bottom: 1px solid var(--border);
      }

      .assertion:last-child {
        border-bottom: none;
      }

      .assertion-header {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .assertion-icon {
        font-size: 11px;
      }

      .assertion-icon.pass { color: var(--green); }
      .assertion-icon.fail { color: var(--red); }

      .assertion-text {
        font-size: 12px;
        color: var(--text-primary);
      }

      .assertion-expand {
        color: var(--text-muted);
        font-size: 10px;
        margin-left: auto;
      }

      /* Resolution chain */
      .assertion-detail {
        display: none;
        margin-top: 8px;
        padding: 12px;
        background: var(--bg-tertiary);
        border-radius: 6px;
        font-size: 11px;
      }

      .assertion.expanded .assertion-detail {
        display: block;
      }

      .resolution-chain {
        margin-bottom: 10px;
      }

      .resolution-step {
        display: flex;
        align-items: flex-start;
        gap: 6px;
        padding: 3px 0;
      }

      .resolution-arrow {
        color: var(--text-muted);
      }

      .resolution-term {
        color: var(--blue);
      }

      .resolution-primitive {
        color: var(--green);
        font-family: ui-monospace, monospace;
        font-size: 11px;
      }

      .check-results {
        border-top: 1px solid var(--border);
        padding-top: 8px;
      }

      .check-result {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 3px 0;
      }

      .check-result.pass { color: var(--green); }
      .check-result.fail { color: var(--red); }

      /* Failure detail */
      .failure-detail {
        background: var(--red-bg);
        border: 1px solid rgba(248, 81, 73, 0.3);
        border-radius: 6px;
        padding: 12px;
        margin-top: 8px;
      }

      .failure-title {
        color: var(--red);
        font-weight: 500;
        margin-bottom: 8px;
      }

      .failure-row {
        font-size: 11px;
        margin: 4px 0;
      }

      .failure-label {
        color: var(--text-muted);
      }

      .failure-value {
        font-family: ui-monospace, monospace;
        color: var(--text-primary);
      }

      /* Warning/Skip states */
      .not-implemented {
        padding: 12px 16px;
        background: var(--yellow-bg);
        border-left: 3px solid var(--yellow);
        margin: 8px 16px;
        border-radius: 4px;
        font-size: 12px;
        color: var(--yellow);
      }

      .skipped-reason {
        padding: 12px 16px;
        background: var(--gray-bg);
        border-left: 3px solid var(--gray);
        margin: 8px 16px;
        border-radius: 4px;
        font-size: 12px;
        color: var(--text-muted);
      }

      /* Loading state */
      .loading {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
      }

      .loading-spinner {
        display: inline-block;
        width: 24px;
        height: 24px;
        border: 2px solid var(--border);
        border-top-color: var(--blue);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-bottom: 12px;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Empty state */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
      }

      /* Toast notification */
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.2s;
        pointer-events: none;
        z-index: 1000;
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      .toast.success { border-color: var(--green); }
      .toast.error { border-color: var(--red); }

      /* Glossary panel */
      .glossary-panel {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-top: 20px;
      }

      .glossary-header {
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
      }

      .glossary-header:hover {
        background: var(--bg-tertiary);
      }

      .glossary-content {
        display: none;
        padding: 16px;
        border-top: 1px solid var(--border);
      }

      .glossary-panel.expanded .glossary-content {
        display: block;
      }

      .glossary-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      .glossary-table th {
        text-align: left;
        padding: 8px;
        color: var(--text-muted);
        border-bottom: 1px solid var(--border);
        font-weight: 500;
      }

      .glossary-table td {
        padding: 8px;
        border-bottom: 1px solid var(--bg-primary);
      }

      .glossary-table tr:hover {
        background: var(--bg-tertiary);
      }

      .glossary-term {
        color: var(--purple);
        font-weight: 500;
      }

      .glossary-meaning {
        color: var(--text-primary);
      }

      .glossary-meaning code {
        background: var(--bg-primary);
        color: var(--blue);
        padding: 1px 4px;
        border-radius: 3px;
        font-size: 11px;
      }

      /* Tooltip popover */
      .tooltip {
        position: fixed;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px 14px;
        max-width: 280px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        z-index: 1000;
        opacity: 0;
        transform: translateY(4px);
        transition: opacity 0.15s ease, transform 0.15s ease;
        pointer-events: none;
      }

      .tooltip.visible {
        opacity: 1;
        transform: translateY(0);
      }

      .tooltip-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
      }

      .tooltip-desc {
        font-size: 11px;
        color: var(--text-secondary);
        line-height: 1.4;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <img
          src="data:image/png;base64,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"
          alt="NTNT"
        />NTNT Intent Studio
      </div>
      <span class="file-name" id="file-name">server.intent</span>

      <div class="header-controls">
        <div class="auto-refresh has-tooltip" data-tooltip-title="Auto-refresh" data-tooltip-desc="Automatically re-run tests every 10 seconds to detect changes">
          <span>Auto-refresh</span>
          <div class="toggle" id="auto-refresh-toggle" onclick="toggleAutoRefresh()"></div>
        </div>
        <button class="btn btn-secondary has-tooltip" onclick="openApp()" data-tooltip-title="Open App" data-tooltip-desc="Open the running application in a new browser tab (port 8081)">üåê Open App</button>
        <a href="/ial-explorer" class="btn btn-secondary has-tooltip" style="text-decoration: none; color: inherit;" data-tooltip-title="IAL Explorer" data-tooltip-desc="Interactive visualization of how glossary terms resolve to test primitives">‚ú¶ IAL Explorer</a>
        <button class="btn btn-primary has-tooltip" id="run-btn" onclick="runTests()" data-tooltip-title="Run Tests" data-tooltip-desc="Execute all tests defined in the intent file against the running server">‚ñ∂ Run Tests</button>
      </div>
    </header>

    <div class="container">
      <!-- Summary bar -->
      <div class="summary-bar" id="summary-bar">
        <div class="status-pill" id="status-pill">
          <span class="status-dot"></span>
          <span id="status-text">Loading...</span>
        </div>
        <div class="summary-top">
          <div>
            <div class="summary-title" id="project-title">Intent Studio</div>
            <div class="summary-subtitle" id="project-subtitle">Loading results...</div>
          </div>
        </div>

        <div class="health-section">
          <div class="health-bar-container">
            <div class="health-bar">
              <div class="health-segment pass" id="health-pass" style="width: 0%"></div>
              <div class="health-segment fail" id="health-fail" style="width: 0%"></div>
              <div class="health-segment warn" id="health-warn" style="width: 0%"></div>
              <div class="health-segment skip" id="health-skip" style="width: 0%"></div>
            </div>
            <div class="health-percent" id="health-percent">--%</div>
          </div>
        </div>

        <div class="summary-stats">
          <div class="stat has-tooltip" onclick="filterBy('pass')" data-tooltip-title="Passing" data-tooltip-desc="Assertions that passed. Click to filter.">
            <span class="stat-icon pass">‚úì</span>
            <span class="stat-value" id="pass-count">-</span>
            <span class="stat-label">Passing</span>
          </div>
          <div class="stat has-tooltip" onclick="filterBy('fail')" data-tooltip-title="Failing" data-tooltip-desc="Assertions that failed. Click to filter.">
            <span class="stat-icon fail">‚úï</span>
            <span class="stat-value" id="fail-count">-</span>
            <span class="stat-label">Failing</span>
          </div>
          <div class="stat has-tooltip" onclick="filterBy('warn')" data-tooltip-title="Warnings" data-tooltip-desc="Scenarios with unresolved outcomes. Click to filter.">
            <span class="stat-icon warn">‚ö†</span>
            <span class="stat-value" id="warn-count">-</span>
            <span class="stat-label">Warnings</span>
          </div>
          <div class="stat has-tooltip" onclick="filterBy('skip')" data-tooltip-title="Skipped" data-tooltip-desc="Scenarios skipped due to unmet preconditions. Click to filter.">
            <span class="stat-icon skip">‚óã</span>
            <span class="stat-value" id="skip-count">-</span>
            <span class="stat-label">Skipped</span>
          </div>
          <div class="stat has-tooltip" onclick="filterBy('unlinked')" data-tooltip-title="Unlinked" data-tooltip-desc="Features without @implements annotation in code. Click to filter.">
            <span class="stat-icon unlinked">‚óá</span>
            <span class="stat-value" id="unlinked-count">-</span>
            <span class="stat-label">Unlinked</span>
          </div>
        </div>
      </div>

      <!-- Filter bar -->
      <div class="filter-bar" id="filter-bar">
        <span class="filter-chip active" data-filter="all" onclick="setFilter('all')">All <span class="filter-count" id="all-count">-</span></span>
        <span class="filter-chip danger" data-filter="fail" onclick="setFilter('fail')">‚úï Failing <span class="filter-count" id="failing-filter-count">0</span></span>
        <span class="filter-chip warning" data-filter="warn" onclick="setFilter('warn')">‚ö† Warnings <span class="filter-count" id="warn-filter-count">0</span></span>
        <span class="filter-chip" data-filter="skip" onclick="setFilter('skip')">‚óã Skipped <span class="filter-count" id="skip-filter-count">0</span></span>
        <span class="filter-chip" data-filter="unlinked" onclick="setFilter('unlinked')">‚óá Unlinked <span class="filter-count" id="unlinked-filter-count">0</span></span>
      </div>

      <!-- Search bar -->
      <div class="search-bar">
        <span class="search-bar-icon">üîç</span>
        <input type="text" id="search-input" placeholder="Search features, scenarios, assertions..." oninput="handleSearch()" />
      </div>

      <!-- Features container -->
      <div id="features-container">
        <div class="loading">
          <div class="loading-spinner"></div>
          <div>Loading test results...</div>
        </div>
      </div>

      <!-- Glossary panel -->
      <div class="glossary-panel" id="glossary-panel">
        <div class="glossary-header" onclick="toggleGlossary()">
          <span>üìñ Glossary</span>
          <span id="glossary-toggle">‚ñ∂</span>
        </div>
        <div class="glossary-content">
          <table class="glossary-table">
            <thead>
              <tr>
                <th>Term</th>
                <th>Meaning</th>
              </tr>
            </thead>
            <tbody id="glossary-body">
              <!-- Populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip">
      <div class="tooltip-title" id="tooltip-title"></div>
      <div class="tooltip-desc" id="tooltip-desc"></div>
    </div>

    <script>
      // State
      let testResults = null;
      let currentFilter = 'all';
      let searchQuery = '';
      let autoRefreshInterval = null;
      let autoRefreshEnabled = false;
      const AUTO_REFRESH_INTERVAL = 10000;
      let expandedFeatures = new Set();
      let expandedScenarios = new Set();

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        fetchResults();
        initTooltips();
      });

      // Initialize tooltips
      function initTooltips() {
        const tooltip = document.getElementById('tooltip');
        const tooltipTitle = document.getElementById('tooltip-title');
        const tooltipDesc = document.getElementById('tooltip-desc');

        document.querySelectorAll('.has-tooltip').forEach(el => {
          el.addEventListener('mouseenter', (e) => {
            const title = el.dataset.tooltipTitle;
            const desc = el.dataset.tooltipDesc;
            if (title) {
              tooltipTitle.textContent = title;
              tooltipDesc.textContent = desc || '';
              tooltip.classList.add('visible');
            }
          });

          el.addEventListener('mouseleave', () => {
            tooltip.classList.remove('visible');
          });

          el.addEventListener('mousemove', (e) => {
            const x = e.clientX + 12;
            const y = e.clientY + 12;

            // Keep tooltip in viewport
            const tooltipRect = tooltip.getBoundingClientRect();
            const maxX = window.innerWidth - tooltipRect.width - 20;
            const maxY = window.innerHeight - tooltipRect.height - 20;

            tooltip.style.left = Math.min(x, maxX) + 'px';
            tooltip.style.top = Math.min(y, maxY) + 'px';
          });
        });
      }

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === '/' && document.activeElement.tagName !== 'INPUT') {
          e.preventDefault();
          document.getElementById('search-input').focus();
        }
      });

      // Toggle auto-refresh
      function toggleAutoRefresh() {
        autoRefreshEnabled = !autoRefreshEnabled;
        const toggle = document.getElementById('auto-refresh-toggle');

        if (autoRefreshEnabled) {
          toggle.classList.add('active');
          autoRefreshInterval = setInterval(fetchResults, AUTO_REFRESH_INTERVAL);
          showToast('Auto-refresh enabled', 'success');
        } else {
          toggle.classList.remove('active');
          if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
          }
          showToast('Auto-refresh disabled', 'success');
        }
      }

      // Open app in new tab
      function openApp() {
        window.open('http://localhost:8081', '_blank');
      }

      // Run tests
      async function runTests() {
        const btn = document.getElementById('run-btn');
        btn.disabled = true;
        btn.textContent = '‚è≥ Running...';

        try {
          await fetchResults();
          showToast('Tests completed', 'success');
        } catch (err) {
          showToast('Test run failed: ' + err.message, 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = '‚ñ∂ Run Tests';
        }
      }

      // Fetch results from API
      async function fetchResults() {
        try {
          const response = await fetch('/run-tests');
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          testResults = data;
          renderResults(data);
          updateStats(data);
          updateGlossary(data.glossary);
        } catch (err) {
          console.error('Failed to fetch results:', err);
          document.getElementById('features-container').innerHTML = `
            <div class="empty-state">
              <div style="color: var(--red); margin-bottom: 12px;">‚ùå Failed to connect</div>
              <div>${err.message}</div>
            </div>
          `;
        }
      }

      // Update stats display
      function updateStats(data) {
        const pass = data.passed_assertions || 0;
        const fail = data.failed_assertions || 0;
        const total = data.total_assertions || 1;

        // Count warnings and skipped
        let warnings = 0;
        let skipped = 0;
        let totalUnresolved = 0;

        if (data.features) {
          data.features.forEach(f => {
            if (f.scenarios) {
              f.scenarios.forEach(s => {
                if (s.status === 'skip') skipped++;
                else if (s.unresolved_outcomes?.length > 0) {
                  warnings++;
                  totalUnresolved += s.unresolved_outcomes.length;
                }
              });
            }
          });
        }

        const unlinked = data.total_features - data.linked_features;

        // Update counts
        document.getElementById('pass-count').textContent = pass;
        document.getElementById('fail-count').textContent = fail;
        document.getElementById('warn-count').textContent = warnings;
        document.getElementById('skip-count').textContent = skipped;
        document.getElementById('unlinked-count').textContent = unlinked;

        // Update filter counts
        document.getElementById('all-count').textContent = data.features?.length || 0;
        document.getElementById('failing-filter-count').textContent = fail > 0 ? data.features?.filter(f => !f.passed).length || 0 : 0;
        document.getElementById('warn-filter-count').textContent = warnings;
        document.getElementById('skip-filter-count').textContent = skipped;
        document.getElementById('unlinked-filter-count').textContent = unlinked;

        // Calculate health bar
        const barTotal = total + totalUnresolved;
        const passWidth = (pass / barTotal) * 100;
        const failWidth = (fail / barTotal) * 100;
        const warnWidth = (totalUnresolved / barTotal) * 100;

        document.getElementById('health-pass').style.width = `${passWidth}%`;
        document.getElementById('health-fail').style.width = `${failWidth}%`;
        document.getElementById('health-warn').style.width = `${warnWidth}%`;
        document.getElementById('health-skip').style.width = '0%';

        // Update percentage
        const percent = Math.round((pass / total) * 100);
        const percentEl = document.getElementById('health-percent');
        percentEl.textContent = `${percent}%`;
        percentEl.className = 'health-percent ' + (percent >= 90 ? 'good' : percent >= 70 ? 'warn' : 'bad');

        // Update status pill
        const statusPill = document.getElementById('status-pill');
        const statusText = document.getElementById('status-text');
        if (fail > 0) {
          statusPill.className = 'status-pill failing';
          statusText.textContent = `${fail} failing`;
        } else if (warnings > 0) {
          statusPill.className = 'status-pill';
          statusText.textContent = `${warnings} warnings`;
        } else {
          statusPill.className = 'status-pill passing';
          statusText.textContent = 'All passing';
        }

        // Update title (from ## Title in intent file)
        const projectTitle = data.title || 'Intent Studio';
        document.getElementById('project-title').textContent = projectTitle;

        // Update subtitle with total checks
        const featureCount = data.features?.length || 0;
        const scenarioCount = data.features?.reduce((sum, f) => sum + (f.scenarios?.length || 0), 0) || 0;
        document.getElementById('project-subtitle').textContent = `${featureCount} features ¬∑ ${scenarioCount} scenarios ¬∑ ${total} checks`;
      }

      // Render results
      function renderResults(data) {
        const container = document.getElementById('features-container');

        if (!data.features || data.features.length === 0) {
          container.innerHTML = '<div class="empty-state">No features found</div>';
          return;
        }

        // Filter features
        let features = data.features;
        if (searchQuery) {
          const q = searchQuery.toLowerCase();
          features = features.filter(f =>
            f.feature_name.toLowerCase().includes(q) ||
            f.feature_id.toLowerCase().includes(q) ||
            f.scenarios?.some(s => s.name?.toLowerCase().includes(q))
          );
        }

        if (currentFilter !== 'all') {
          features = features.filter(f => {
            if (currentFilter === 'fail') return !f.passed;
            if (currentFilter === 'warn') return f.scenarios?.some(s => s.unresolved_outcomes?.length > 0);
            if (currentFilter === 'skip') return f.scenarios?.some(s => s.status === 'skip');
            if (currentFilter === 'unlinked') return !f.has_implementation;
            return true;
          });
        }

        container.innerHTML = features.map(renderFeature).join('');
      }

      // Render a feature card
      function renderFeature(feature) {
        const isExpanded = expandedFeatures.has(feature.feature_id);
        const isUnlinked = !feature.has_implementation;
        const hasWarnings = feature.scenarios?.some(s => s.unresolved_outcomes?.length > 0);
        const hasSkipped = feature.scenarios?.some(s => s.status === 'skip');
        // Check for actual test failures (not just unresolved outcomes)
        const hasFailedAssertions = feature.scenarios?.some(s =>
          s.test_result?.assertions?.some(a => !a.passed)
        ) || feature.tests?.some(t => t.assertions?.some(a => !a.passed));

        // Priority: fail (actual assertion failures) > warn > skip > unlinked > pass
        let icon;
        if (hasFailedAssertions) {
          icon = 'fail';
        } else if (hasWarnings) {
          icon = 'warn';
        } else if (hasSkipped) {
          icon = 'skip';
        } else if (isUnlinked) {
          icon = 'unlinked';
        } else {
          icon = 'pass';
        }

        const iconMap = { pass: '‚úì', fail: '‚úï', warn: '‚ö†', skip: '‚óã', unlinked: '‚óá' };
        const scenarioCount = feature.scenarios?.length || 0;
        const checkCount = feature.tests?.reduce((sum, t) => sum + (t.assertions?.length || 0), 0) || 0;

        // Check if this is a unit test feature (has CODE_QUALITY or FUNCTION_CALL tests)
        const isUnitTest = feature.tests?.some(t => t.method === 'CODE_QUALITY' || t.method === 'FUNCTION_CALL') ||
                          feature.scenarios?.some(s => s.test_result?.method === 'FUNCTION_CALL' || s.test_result?.method === 'CODE_QUALITY');

        return `
          <div class="feature-card ${isExpanded ? 'expanded' : ''}" data-feature-id="${feature.feature_id}">
            <div class="feature-header" onclick="toggleFeature('${feature.feature_id}')">
              <div class="feature-left">
                <div class="feature-icon ${icon}">${iconMap[icon]}</div>
                <div class="feature-name">${escapeHtml(feature.feature_name)}</div>
                ${isUnitTest ? '<span class="badge unit">Unit</span>' : ''}
                ${isUnlinked ? '<span class="badge unlinked">Unlinked</span>' : ''}
              </div>
              <div class="feature-right">
                <div class="feature-stats">${scenarioCount} scenario${scenarioCount !== 1 ? 's' : ''} ¬∑ ${checkCount || 0} checks</div>
                <span class="expand-icon">‚ñº</span>
              </div>
            </div>
            <div class="scenarios">
              ${feature.description ? `
                <div class="feature-description">
                  <div class="feature-id">${feature.feature_id}</div>
                  ${escapeHtml(feature.description)}
                </div>
              ` : ''}
              ${(feature.scenarios || []).map((s, idx) => renderScenario(s, feature.feature_id, idx)).join('')}
              ${(feature.scenarios?.length === 0 && feature.tests?.length > 0) ? feature.tests.map((t, idx) => renderTest(t, feature.feature_id, idx)).join('') : ''}
              ${hasWarnings ? renderWarnings(feature) : ''}
              ${hasSkipped ? renderSkipped(feature) : ''}
            </div>
          </div>
        `;
      }

      // Render a scenario
      function renderScenario(scenario, featureId, idx) {
        const key = `${featureId}:${idx}`;
        const isExpanded = expandedScenarios.has(key);
        const status = scenario.status || 'pending';
        const hasWarnings = scenario.unresolved_outcomes?.length > 0;
        const icon = hasWarnings ? 'warn' : status;
        const iconMap = { pass: '‚úì', fail: '‚úï', warn: '‚ö†', skip: '‚óã', pending: '‚óã' };

        const testResult = scenario.test_result;
        const assertions = testResult?.assertions || [];
        const checkCount = assertions.length;

        return `
          <div class="scenario ${isExpanded ? 'expanded' : ''}" data-scenario-key="${key}">
            <div class="scenario-header" onclick="toggleScenario('${key}')">
              <div class="scenario-left">
                <span class="scenario-icon ${icon}">${iconMap[icon]}</span>
                <span class="scenario-name">${escapeHtml(scenario.name || 'Unnamed scenario')}</span>
              </div>
              <span class="scenario-meta">${checkCount} check${checkCount !== 1 ? 's' : ''}</span>
            </div>
            <div class="assertions">
              ${scenario.when_clause ? `
                <div class="when-clause">
                  <div class="when-line"><span class="when-label">When</span> ${escapeHtml(scenario.when_clause)}</div>
                  ${testResult ? `<div class="resolution">‚Üí ${testResult.method} ${testResult.path}</div>` : ''}
                </div>
              ` : ''}
              ${assertions.map(a => renderAssertion(a)).join('')}
            </div>
          </div>
        `;
      }

      // Render an assertion
      function renderAssertion(assertion) {
        const status = assertion.passed ? 'pass' : 'fail';
        const icon = assertion.passed ? '‚úì' : '‚úï';

        return `
          <div class="assertion">
            <div class="assertion-header">
              <span class="assertion-icon ${status}">${icon}</span>
              <span class="assertion-text">${escapeHtml(assertion.assertion_text)}</span>
            </div>
            ${assertion.message && !assertion.passed ? `
              <div class="failure-detail">
                <div class="failure-title">Assertion Failed</div>
                <div class="failure-row">
                  <span class="failure-label">Message: </span>
                  <span class="failure-value">${escapeHtml(assertion.message)}</span>
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }

      // Render a direct test block (when no scenarios exist)
      function renderTest(test, featureId, idx) {
        const key = `${featureId}:test:${idx}`;
        const isExpanded = expandedScenarios.has(key);
        const status = test.passed ? 'pass' : 'fail';
        const iconMap = { pass: '‚úì', fail: '‚úï' };
        const assertions = test.assertions || [];
        const checkCount = assertions.length;

        return `
          <div class="scenario ${isExpanded ? 'expanded' : ''}" data-scenario-key="${key}">
            <div class="scenario-header" onclick="toggleScenario('${key}')">
              <div class="scenario-left">
                <span class="scenario-icon ${status}">${iconMap[status]}</span>
                <span class="scenario-name">${test.method} ${escapeHtml(test.path)}</span>
              </div>
              <span class="scenario-meta">${checkCount} check${checkCount !== 1 ? 's' : ''}</span>
            </div>
            <div class="assertions">
              ${assertions.map(a => renderAssertion(a)).join('')}
            </div>
          </div>
        `;
      }

      // Render warnings
      function renderWarnings(feature) {
        const warnings = [];
        feature.scenarios?.forEach(s => {
          if (s.unresolved_outcomes?.length > 0) {
            warnings.push(`Scenario "${s.name}" has ${s.unresolved_outcomes.length} unresolved outcome(s)`);
          }
        });
        return warnings.map(w => `<div class="not-implemented">‚ö† ${escapeHtml(w)}</div>`).join('');
      }

      // Render skipped
      function renderSkipped(feature) {
        const skipped = feature.scenarios?.filter(s => s.status === 'skip') || [];
        return skipped.map(s =>
          `<div class="skipped-reason">‚óã Skipped: "${escapeHtml(s.name)}" - Precondition not met</div>`
        ).join('');
      }

      // Toggle feature expansion
      function toggleFeature(featureId) {
        if (expandedFeatures.has(featureId)) {
          expandedFeatures.delete(featureId);
        } else {
          expandedFeatures.add(featureId);
        }
        if (testResults) renderResults(testResults);
      }

      // Toggle scenario expansion
      function toggleScenario(key) {
        if (expandedScenarios.has(key)) {
          expandedScenarios.delete(key);
        } else {
          expandedScenarios.add(key);
        }
        if (testResults) renderResults(testResults);
      }

      // Set filter
      function setFilter(filter) {
        currentFilter = filter;

        // Update active state
        document.querySelectorAll('.filter-chip').forEach(chip => {
          chip.classList.remove('active');
          if (chip.dataset.filter === filter) {
            chip.classList.add('active');
          }
        });

        if (testResults) renderResults(testResults);
      }

      // Filter by stat click
      function filterBy(filter) {
        setFilter(filter);
      }

      // Handle search
      function handleSearch() {
        searchQuery = document.getElementById('search-input').value;
        if (testResults) renderResults(testResults);
      }

      // Toggle glossary
      function toggleGlossary() {
        const panel = document.getElementById('glossary-panel');
        const toggle = document.getElementById('glossary-toggle');
        panel.classList.toggle('expanded');
        toggle.textContent = panel.classList.contains('expanded') ? '‚ñº' : '‚ñ∂';
      }

      // Update glossary
      function updateGlossary(glossary) {
        const body = document.getElementById('glossary-body');
        if (!glossary || glossary.length === 0) {
          body.innerHTML = '<tr><td colspan="2" style="color: var(--text-muted);">No glossary terms defined</td></tr>';
          return;
        }

        body.innerHTML = glossary.map(g => `
          <tr>
            <td class="glossary-term">${escapeHtml(g.term)}</td>
            <td class="glossary-meaning">${formatMeaning(g.meaning)}</td>
          </tr>
        `).join('');
      }

      // Format glossary meaning
      function formatMeaning(meaning) {
        return escapeHtml(meaning)
          .replace(/`([^`]+)`/g, '<code>$1</code>')
          .replace(/(GET|POST|PUT|DELETE|PATCH)\s+(\/\S+)/g, '<code>$1 $2</code>');
      }

      // Show toast notification
      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast show ${type}`;
        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }

      // Escape HTML
      function escapeHtml(str) {
        if (!str) return '';
        return str
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }
    </script>
  </body>
</html>
